<div class="editor-modal">
  <div class="editor-backdrop" (click)="close()"></div>

  <div class="editor-dialog">

    <ng-container *ngIf="stockOut$ | async as stockOut; else newMode">

      <section class="panel form-panel">
        <header class="dialog-header">
          <div>
            <p class="eyebrow">Stock out</p>
            <h3>Edit stock out</h3>
            <p class="sub">Add line items for products and quantities.</p>

            <p class="meta">
              Running number:
              <strong>{{ stockOut.runningNumber || runningNumber || 'SO001' }}</strong>
            </p>

            <p class="meta">
              Status:
              <strong>{{ stockOut.finalized ? 'Finalized' : 'Draft' }}</strong>
            </p>
          </div>

          <div class="header-actions">
            <button class="ghost-btn" type="button" (click)="close()">Close</button>

            <button
              class="primary-btn"
              type="button"
              *ngIf="!stockOut.finalized"
              (click)="finalizeStockOut()"
              [disabled]="saving"
            >
              Finalize
            </button>
          </div>
        </header>

        <ng-container [ngTemplateOutlet]="formBody" [ngTemplateOutletContext]="{ finalized: stockOut.finalized }"></ng-container>
      </section>
    </ng-container>

    <ng-template #newMode>
      <section class="panel form-panel">
        <header class="dialog-header">
          <div>
            <p class="eyebrow">New stock out</p>
            <h3>Create stock out</h3>
            <p class="sub">Add line items for products and quantities.</p>
            <p class="meta">Running number: <strong>{{ runningNumber }}</strong></p>
            <p class="meta">Status: <strong>Draft</strong></p>
          </div>

          <div class="header-actions">
            <button class="ghost-btn" type="button" (click)="close()">Close</button>
          </div>
        </header>

        <ng-container [ngTemplateOutlet]="formBody" [ngTemplateOutletContext]="{ finalized: false }"></ng-container>
      </section>
    </ng-template>
  </div>
</div>

<ng-template #formBody let-finalized="finalized">
  <!-- ========================= -->
  <!-- FORM -->
  <!-- ========================= -->
  <form [formGroup]="stockOutForm" (ngSubmit)="saveStockOut()">

    <div class="field">
      <label for="stock-date">Date</label>
      <input id="stock-date" type="date" formControlName="date" />
    </div>

    <div class="field">
      <label for="stock-description">Description</label>
      <textarea
        id="stock-description"
        rows="3"
        formControlName="description"
      ></textarea>
    </div>

    <!-- DETAILS -->
    <div class="detail-header">
      <h4>Details</h4>
      <button
        class="ghost-btn"
        type="button"
        (click)="addDetail()"
        [disabled]="finalized"
      >
        Add line
      </button>
    </div>

    <ng-container *ngIf="productsVm$ | async as productsVm">
      <div class="detail-list" formArrayName="details">
        <div
          class="detail-row"
          *ngFor="let detail of details.controls; let i = index"
          [formGroupName]="i"
        >

        <!-- PRODUCT -->
        <div class="field">
          <label>Product</label>
          <div class="search-select">
            <input
              type="text"
              formControlName="searchTerm"
              placeholder="Search product"
              (focus)="setActiveSearch(i)"
              (blur)="clearActiveSearch()"
            />

            <div class="search-options" *ngIf="activeSearchIndex === i">
              <ng-container *ngIf="getFilteredProducts(i, productsVm.items) as filteredProducts">
                <button
                  class="search-option"
                  type="button"
                  *ngFor="let product of filteredProducts"
                  (mousedown)="
                    selectProduct(i, product.id, productsVm.items);
                    detail.get('searchTerm')?.setValue(product.productName);
                    clearActiveSearch()
                  "
                >
                  {{ product.productName }}
                </button>

                <div
                  class="search-empty"
                  *ngIf="!productsVm.loading && !filteredProducts.length"
                >
                  No products found
                </div>
              </ng-container>
            </div>
          </div>
          <input type="hidden" formControlName="productId" />
        </div>

        <!-- SKU -->
        <div class="field">
          <label>SKU</label>
          <ng-container *ngIf="getSkusForDetail$(i) | async as skus">
            <select
              formControlName="sku"
              [disabled]="!skus.length || skus.length === 1"
            >
              <option value="">Select SKU</option>
              <option
                *ngFor="let sku of skus"
                [value]="sku.skuCode"
              >
                {{ sku.skuCode }}
              </option>
            </select>

            <small
              *ngIf="skus.length === 1"
              class="hint"
            >
              Auto-selected
            </small>

            <small
              *ngIf="skus.length === 0"
              class="hint"
            >
              No SKU found
            </small>
          </ng-container>
        </div>

        <!-- QTY -->
        <div class="field">
          <label>Quantity</label>
          <input type="number" min="1" formControlName="quantity" />
        </div>

        <button
          class="ghost-btn danger"
          type="button"
          (click)="removeDetail(i)"
          [disabled]="details.length === 1 || finalized"
        >
          Remove
        </button>

        </div>
      </div>

      <div class="state error" *ngIf="productsVm.error">{{ productsVm.error }}</div>
    </ng-container>
    <div class="state error" *ngIf="saveError">{{ saveError }}</div>

    <div class="form-actions">
      <button class="ghost-btn" type="button" (click)="close()">
        Cancel
      </button>

      <button
        class="primary-btn"
        type="submit"
        [disabled]="saving || finalized"
      >
        {{ saving ? 'Saving...' : 'Save stock out' }}
      </button>
    </div>
  </form>
</ng-template>
